version: "3.8"

services:
  # The Auteur System - Video Generation Pipeline
  # Base: PyTorch 25.10 (CUDA 13.0.2, Blackwell-optimized)
  auteur-pipeline:
    container_name: auteur-video-pipeline
    build:
      context: .
      dockerfile: Dockerfile.auteur
      args:
        - BUILDKIT_INLINE_CACHE=1
    image: auteur-video-pipeline:1.1.0
    restart: unless-stopped
    ipc: host
    # Security settings for kernel compilation
    security_opt:
      - seccomp:unconfined
    cap_add:
      - SYS_PTRACE
    ulimits:
      memlock: -1
      stack: 67108864
    ports:
      - "8100:8100"  # API endpoint
    volumes:
      - /home/antoine1anthony/huggingface_cache:/root/.cache/huggingface
      - /home/antoine1anthony/auteur-system/outputs:/app/outputs
      - /home/antoine1anthony/auteur-system/configs:/app/configs:ro
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - HF_HOME=/root/.cache/huggingface
      - CUDA_VISIBLE_DEVICES=0
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
      # FP8 Configuration
      - AUTEUR_COMPUTE_DTYPE=float8_e4m3fn
      - AUTEUR_ATTENTION_BACKEND=sdpa
      - AUTEUR_TORCH_COMPILE=true
    healthcheck:
      test: ["CMD", "python", "-c", "import torch; assert torch.cuda.is_available()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

networks:
  default:
    name: auteur_network
